# IPTables ç®¡ç†å™¨ä½¿ç”¨è¯´æ˜

NSPass Agent çš„ iptables ç®¡ç†å™¨å®ç°äº†æ™ºèƒ½çš„è§„åˆ™å¯¹æ¯”å’Œå¢é‡æ›´æ–°åŠŸèƒ½ï¼Œèƒ½å¤Ÿå®‰å…¨ã€é«˜æ•ˆåœ°ç®¡ç†é˜²ç«å¢™è§„åˆ™ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. å†…å­˜é…ç½®ç»´æŠ¤
- åœ¨å†…å­˜ä¸­ç»´æŠ¤æœŸæœ›çš„è§„åˆ™é…ç½®çŠ¶æ€
- å®æ—¶è·Ÿè¸ªå½“å‰ç³»ç»Ÿä¸­çš„è§„åˆ™çŠ¶æ€
- ç®¡ç†è‡ªå®šä¹‰é“¾çš„åˆ›å»ºå’Œåˆ é™¤

### 2. é…ç½®å¯¹æ¯”ä¸å¢é‡æ›´æ–°
- è‡ªåŠ¨å¯¹æ¯”æœŸæœ›é…ç½®ä¸å½“å‰ç³»ç»Ÿé…ç½®
- åªåˆ é™¤å¤šä½™çš„è§„åˆ™ï¼Œåªæ·»åŠ ç¼ºå¤±çš„è§„åˆ™
- é¿å…ä¸å¿…è¦çš„è§„åˆ™é‡å»ºï¼Œæé«˜æ€§èƒ½

### 3. è¯¦ç»†æ—¥å¿—è®°å½•
- å®Œæ•´çš„æ“ä½œæ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•å’Œå®¡è®¡
- ç»“æ„åŒ–æ—¥å¿—æ ¼å¼ï¼ˆJSONï¼‰
- ä¸åŒçº§åˆ«çš„æ—¥å¿—è¾“å‡ºï¼ˆdebug, info, warn, errorï¼‰

### 4. å®‰å…¨çš„å¤‡ä»½æœºåˆ¶
- æ¯æ¬¡æ›´æ–°å‰è‡ªåŠ¨å¤‡ä»½å½“å‰è§„åˆ™
- æ”¯æŒå¤šç§æŒä¹…åŒ–æ–¹æ³•
- å¯é…ç½®çš„å¤‡ä»½è·¯å¾„

## ğŸ“ é…ç½®é€‰é¡¹

```yaml
iptables:
  enable: true                          # æ˜¯å¦å¯ç”¨iptablesç®¡ç†
  backup_path: "/etc/nspass/iptables-backup"  # å¤‡ä»½æ–‡ä»¶è·¯å¾„
  persistent_method: "iptables-save"    # æŒä¹…åŒ–æ–¹æ³•
  chain_prefix: "NSPASS"                # ç®¡ç†çš„é“¾å‰ç¼€
```

### æŒä¹…åŒ–æ–¹æ³•
- `iptables-save`: ä½¿ç”¨ iptables-save å‘½ä»¤ä¿å­˜è§„åˆ™
- `netfilter-persistent`: ä½¿ç”¨ netfilter-persistent æœåŠ¡

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. åˆå§‹åŒ–é˜¶æ®µ
```
å¯åŠ¨æ—¶è¯»å–å½“å‰ç³»ç»Ÿiptablesé…ç½® â†’ è§£æå¹¶å­˜å‚¨åˆ°å†…å­˜
```

### 2. æ›´æ–°æµç¨‹
```
APIè·å–æ–°é…ç½® â†’ é‡å»ºæœŸæœ›é…ç½® â†’ é‡æ–°è¯»å–å½“å‰é…ç½® â†’ å¯¹æ¯”å·®å¼‚ â†’ åº”ç”¨å˜æ›´ â†’ æŒä¹…åŒ–
```

### 3. é…ç½®å¯¹æ¯”
- **éœ€è¦åˆ é™¤**: å½“å‰æœ‰ä½†æœŸæœ›æ²¡æœ‰çš„è§„åˆ™
- **éœ€è¦æ·»åŠ **: æœŸæœ›æœ‰ä½†å½“å‰æ²¡æœ‰çš„è§„åˆ™
- **ä¿æŒä¸å˜**: ä¸¤è¾¹éƒ½æœ‰ä¸”ç›¸åŒçš„è§„åˆ™

## ğŸ“Š æ—¥å¿—ç¤ºä¾‹

### å¯åŠ¨æ—¶æ—¥å¿—
```json
{
  "timestamp": "2025-01-01T10:00:00Z",
  "level": "info",
  "message": "å¼€å§‹åŠ è½½å½“å‰ç³»ç»Ÿiptablesé…ç½®"
}
```

### é…ç½®å¯¹æ¯”æ—¥å¿—
```json
{
  "timestamp": "2025-01-01T10:00:05Z",
  "level": "info", 
  "message": "é…ç½®å·®å¼‚åˆ†æå®Œæˆ",
  "rules_to_delete": 2,
  "rules_to_add": 3,
  "current_rules": 10,
  "desired_rules": 11
}
```

### è§„åˆ™æ“ä½œæ—¥å¿—
```json
{
  "timestamp": "2025-01-01T10:00:06Z",
  "level": "info",
  "message": "æˆåŠŸæ·»åŠ è§„åˆ™",
  "rule_id": "rule-123",
  "table": "filter",
  "chain": "INPUT",
  "rule": "-p tcp --dport 80 -j ACCEPT"
}
```

## ğŸ› ï¸ API æ¥å£

### è§„åˆ™é…ç½®æ ¼å¼
```json
{
  "iptables_rules": [
    {
      "id": "rule-1",
      "table": "filter",
      "chain": "INPUT", 
      "rule": "-p tcp --dport 22 -j ACCEPT",
      "action": "add",
      "enabled": true
    }
  ]
}
```

### æ”¯æŒçš„è¡¨ç±»å‹
- `filter`: æ•°æ®åŒ…è¿‡æ»¤ï¼ˆé»˜è®¤è¡¨ï¼‰
- `nat`: ç½‘ç»œåœ°å€è½¬æ¢
- `mangle`: æ•°æ®åŒ…ä¿®æ”¹
- `raw`: åŸå§‹æ•°æ®åŒ…å¤„ç†

### æ”¯æŒçš„é“¾ç±»å‹
- `INPUT`: è¿›å…¥æœ¬æœºçš„æ•°æ®åŒ…
- `OUTPUT`: æœ¬æœºå‘å‡ºçš„æ•°æ®åŒ…
- `FORWARD`: è½¬å‘çš„æ•°æ®åŒ…
- `PREROUTING`: è·¯ç”±å‰å¤„ç†
- `POSTROUTING`: è·¯ç”±åå¤„ç†

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### è·å–è§„åˆ™æ‘˜è¦
ç®¡ç†å™¨æä¾› `GetRulesSummary()` æ–¹æ³•è·å–å½“å‰çŠ¶æ€ï¼š

```json
{
  "desired_rules_count": 15,
  "current_rules_count": 12,
  "managed_chains": 3,
  "enabled": true,
  "chain_prefix": "NSPASS",
  "rules_by_table": {
    "filter": 10,
    "nat": 3,
    "mangle": 2
  }
}
```

### è°ƒè¯•æ¨¡å¼
è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º `debug` æŸ¥çœ‹è¯¦ç»†æ“ä½œï¼š

```yaml
log_level: "debug"
```

è¿™å°†æ˜¾ç¤ºï¼š
- æ‰§è¡Œçš„æ¯ä¸ª iptables å‘½ä»¤
- è§„åˆ™è§£æè¿‡ç¨‹
- é…ç½®å¯¹æ¯”ç»†èŠ‚

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æƒé™è¦æ±‚
- å¿…é¡»ä»¥ root æƒé™è¿è¡Œ
- éœ€è¦ iptables å‘½ä»¤å¯ç”¨

### 2. å®‰å…¨è€ƒè™‘
- åªç®¡ç†å¸¦æœ‰æŒ‡å®šå‰ç¼€çš„è§„åˆ™å’Œé“¾
- ä¸ä¼šå½±å“ç³»ç»Ÿé»˜è®¤çš„é˜²ç«å¢™è§„åˆ™
- è‡ªåŠ¨å¤‡ä»½æœºåˆ¶é˜²æ­¢é…ç½®ä¸¢å¤±

### 3. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨è§„åˆ™é”®å€¼ç¼“å­˜é¿å…é‡å¤æ“ä½œ
- æ‰¹é‡å¤„ç†è§„åˆ™å˜æ›´
- æ™ºèƒ½çš„å·®å¼‚æ£€æµ‹ç®—æ³•

### 4. æ•…éšœæ¢å¤
- æ¯æ¬¡æ›´æ–°å‰åˆ›å»ºå¤‡ä»½
- æ”¯æŒæ‰‹åŠ¨æ¸…ç©ºæ‰€æœ‰ç®¡ç†çš„è§„åˆ™
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨
```bash
# å¯åŠ¨æœåŠ¡ï¼ˆdebugæ¨¡å¼ï¼‰
./nspass-agent --config /etc/nspass/config.yaml --log-level debug

# æŸ¥çœ‹æ—¥å¿—
journalctl -u nspass-agent -f
```

### æ‰‹åŠ¨æµ‹è¯•
```bash
# æŸ¥çœ‹å½“å‰iptablesè§„åˆ™
iptables -L -n --line-numbers

# æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶
ls -la /etc/nspass/iptables-backup/
```

é€šè¿‡è¿™ç§æ™ºèƒ½çš„iptablesç®¡ç†æ–¹å¼ï¼ŒNSPass Agentèƒ½å¤Ÿå®‰å…¨ã€é«˜æ•ˆåœ°ç®¡ç†é˜²ç«å¢™è§„åˆ™ï¼Œç¡®ä¿ç³»ç»Ÿå®‰å…¨çš„åŒæ—¶æä¾›çµæ´»çš„é…ç½®èƒ½åŠ›ã€‚ 