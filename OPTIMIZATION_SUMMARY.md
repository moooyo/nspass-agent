# NSPass Agent å®‰è£…è„šæœ¬ä¼˜åŒ–æ€»ç»“

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

ä¼˜åŒ– NSPass Agent çš„å®‰è£…å’Œå¸è½½è„šæœ¬ï¼Œå®ç°ä» GitHub Releases è‡ªåŠ¨ä¸‹è½½å’Œå®‰è£…æœ€æ–°ç‰ˆæœ¬çš„åŠŸèƒ½ï¼Œå¹¶æ”¯æŒé€šè¿‡å‘½ä»¤è¡Œå‚æ•°ç›´æ¥é…ç½®æœåŠ¡å™¨IDå’ŒAPIä»¤ç‰Œã€‚

## ğŸš€ ä¸»è¦æ”¹è¿›

### 1. å®‰è£…è„šæœ¬ä¼˜åŒ– (`scripts/install.sh`)

#### æ–°å¢åŠŸèƒ½ï¼š
- **å‘½ä»¤è¡Œå‚æ•°æ”¯æŒ**: æ”¯æŒ `--server-id` å’Œ `--token` å‚æ•°
- **è‡ªåŠ¨é…ç½®å†™å…¥**: å°†å‚æ•°ç›´æ¥å†™å…¥é…ç½®æ–‡ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨ç¼–è¾‘
- **å¤šæ¶æ„æ”¯æŒ**: è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿæ¶æ„ï¼ˆamd64ã€arm64ã€armã€386ï¼‰
- **å¢å¼ºçš„ç‰ˆæœ¬æ£€æŸ¥**: æ”¯æŒä» GitHub API è·å–æœ€æ–°ç‰ˆæœ¬ï¼ŒåŒ…å«é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶
- **æ™ºèƒ½ä¸‹è½½**: æ”¯æŒå¤šç§ä¸‹è½½æ ¼å¼ï¼ˆç›´æ¥äºŒè¿›åˆ¶ã€tar.gzå‹ç¼©åŒ…ï¼‰
- **å®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿ**: æ·»åŠ æ—¥å¿—ç›®å½•åˆ›å»ºå’Œæƒé™è®¾ç½®
- **æ”¹è¿›çš„é…ç½®ç®¡ç†**: ç”Ÿæˆæ›´å®Œæ•´çš„é»˜è®¤é…ç½®æ–‡ä»¶
- **å¢å¼ºçš„é”™è¯¯å¤„ç†**: æ›´å¥½çš„é”™è¯¯ä¿¡æ¯å’Œæ•…éšœæ’é™¤å»ºè®®

#### ä½¿ç”¨æ–¹æ³•ï¼š
```bash
# åŸºç¡€å®‰è£…
curl -sSL https://raw.githubusercontent.com/nspass/nspass-agent/main/scripts/install.sh | sudo bash

# å¸¦é…ç½®å‚æ•°å®‰è£…
curl -sSL https://raw.githubusercontent.com/nspass/nspass-agent/main/scripts/install.sh | sudo bash -s -- --server-id=server001 --token=your-token

# æŸ¥çœ‹å¸®åŠ©
curl -sSL https://raw.githubusercontent.com/nspass/nspass-agent/main/scripts/install.sh | bash -s -- --help
```

#### å…³é”®æ”¹è¿›ï¼š
```bash
# å‚æ•°è§£æ
parse_args() {
    # æ”¯æŒ --server-id å’Œ --token å‚æ•°
    # åŒ…å«å‚æ•°éªŒè¯å’Œå¸®åŠ©ä¿¡æ¯
}

# é…ç½®æ–‡ä»¶ç”Ÿæˆ
setup_config() {
    # è‡ªåŠ¨ä½¿ç”¨æä¾›çš„å‚æ•°
    # æ”¯æŒç°æœ‰é…ç½®æ–‡ä»¶çš„æ›´æ–°
    # æ™ºèƒ½é…ç½®å¤‡ä»½å’Œæ¢å¤
}
```

### 2. å¸è½½è„šæœ¬ä¼˜åŒ– (`scripts/uninstall.sh`)

#### æ–°å¢åŠŸèƒ½ï¼š
- **æ—¥å¿—ç›®å½•æ¸…ç†**: æ”¯æŒæ¸…ç† `/var/log/nspass` ç›®å½•
- **å¢å¼ºçš„æ®‹ç•™æ£€æŸ¥**: æ£€æŸ¥æ›´å¤šå¯èƒ½çš„æ®‹ç•™æ–‡ä»¶ä½ç½®
- **æ”¹è¿›çš„ç”¨æˆ·äº¤äº’**: æ›´æ¸…æ™°çš„æç¤ºä¿¡æ¯å’Œé€‰æ‹©æµç¨‹
- **å®Œå–„çš„æ¸…ç†å»ºè®®**: æä¾›è¯¦ç»†çš„æ‰‹åŠ¨æ¸…ç†å»ºè®®

#### å…³é”®æ”¹è¿›ï¼š
```bash
# é…ç½®æ–‡ä»¶å¤„ç†å¢å¼º
handle_config_files() {
    # åˆ†åˆ«å¤„ç†é…ç½®ç›®å½•å’Œæ—¥å¿—ç›®å½•
    # æ”¹è¿›çš„ç”¨æˆ·äº¤äº’
}

# æ®‹ç•™æ£€æŸ¥å¢å¼º
check_residual_files() {
    # æ£€æŸ¥æ›´å¤šè·¯å¾„
    # æ£€æŸ¥cronä½œä¸š
    # æä¾›æ¸…ç†å»ºè®®
}
```

### 3. æµ‹è¯•å®‰è£…è„šæœ¬ä¼˜åŒ– (`scripts/test-install.sh`)

#### åŠŸèƒ½ç‰¹ç‚¹ï¼š
- **å‚æ•°æ”¯æŒ**: åŒæ ·æ”¯æŒ `--server-id` å’Œ `--token` å‚æ•°
- **æœ¬åœ°æ„å»ºå®‰è£…**: ä½¿ç”¨æœ¬åœ°æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œæµ‹è¯•
- **è‡ªåŠ¨æ„å»º**: å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ„å»ºæ–‡ä»¶ï¼Œè‡ªåŠ¨æ‰§è¡Œæ„å»º
- **æµ‹è¯•é…ç½®**: ç”Ÿæˆé€‚åˆæµ‹è¯•çš„é…ç½®æ–‡ä»¶ï¼Œæ”¯æŒå‚æ•°è‡ªåŠ¨è®¾ç½®
- **å¼€å‘å‹å¥½**: æä¾›è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯å’Œæµ‹è¯•å‘½ä»¤

#### ä½¿ç”¨æ–¹æ³•ï¼š
```bash
# åŸºç¡€æµ‹è¯•å®‰è£…
sudo ./scripts/test-install.sh

# å¸¦é…ç½®å‚æ•°çš„æµ‹è¯•å®‰è£…
sudo ./scripts/test-install.sh --server-id=test-server-001 --token=test-token
```

### 4. æ–°å¢å‘å¸ƒè„šæœ¬ (`scripts/release.sh`)

#### åŠŸèƒ½ç‰¹ç‚¹ï¼š
- **å¤šå¹³å°æ„å»º**: æ”¯æŒ Linuxã€macOSã€Windows çš„å¤šç§æ¶æ„
- **è‡ªåŠ¨åŒ–æ‰“åŒ…**: è‡ªåŠ¨ç”Ÿæˆå‹ç¼©åŒ…å’Œæ ¡éªŒå’Œæ–‡ä»¶
- **å‘å¸ƒè¯´æ˜**: è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜æ–‡æ¡£
- **ç¯å¢ƒæ£€æŸ¥**: å®Œæ•´çš„æ„å»ºç¯å¢ƒæ£€æŸ¥

#### æ”¯æŒçš„å¹³å°ï¼š
```bash
platforms=(
    ["linux-amd64"]="linux:amd64"
    ["linux-arm64"]="linux:arm64"
    ["linux-arm"]="linux:arm"
    ["darwin-amd64"]="darwin:amd64"
    ["darwin-arm64"]="darwin:arm64"
    ["windows-amd64"]="windows:amd64"
)
```

### 5. æ„å»ºç³»ç»Ÿä¼˜åŒ–

#### Makefile å¢å¼ºï¼š
- æ–°å¢ `release` ç›®æ ‡ï¼šæ‰§è¡Œå‘å¸ƒæ„å»º
- æ–°å¢ `release-github` ç›®æ ‡ï¼šå‘å¸ƒåˆ° GitHub
- ä¼˜åŒ–å¸®åŠ©æ–‡æ¡£ï¼šæ›´æ¸…æ™°çš„å‘½ä»¤è¯´æ˜

#### GitHub Actions å·¥ä½œæµï¼š
- è‡ªåŠ¨åŒ–æ„å»ºå’Œå‘å¸ƒæµç¨‹
- æ”¯æŒæ ‡ç­¾è§¦å‘å’Œæ‰‹åŠ¨è§¦å‘
- ç”Ÿæˆå®Œæ•´çš„å‘å¸ƒåŒ…

## ğŸ“ æ–‡ä»¶ç»“æ„

```
scripts/
â”œâ”€â”€ install.sh          # ä¸»å®‰è£…è„šæœ¬ (ä¼˜åŒ–)
â”œâ”€â”€ uninstall.sh        # å¸è½½è„šæœ¬ (ä¼˜åŒ–)
â”œâ”€â”€ test-install.sh     # æµ‹è¯•å®‰è£…è„šæœ¬ (æ–°å¢)
â””â”€â”€ release.sh          # å‘å¸ƒè„šæœ¬ (æ–°å¢)

docs/
â””â”€â”€ installation.md     # å®‰è£…æŒ‡å— (æ–°å¢)

.github/workflows/
â””â”€â”€ release.yml         # GitHub Actions å·¥ä½œæµ (ä¼˜åŒ–)
```

## ğŸ‰ ä½¿ç”¨æ–¹æ³•

### ç”Ÿäº§ç¯å¢ƒå®‰è£…
```bash
# è‡ªåŠ¨å®‰è£…æœ€æ–°ç‰ˆæœ¬
curl -sSL https://raw.githubusercontent.com/nspass/nspass-agent/main/scripts/install.sh | sudo bash

# å¸¦é…ç½®å‚æ•°çš„å®‰è£…ï¼ˆæ¨èï¼‰
curl -sSL https://raw.githubusercontent.com/nspass/nspass-agent/main/scripts/install.sh | sudo bash -s -- --server-id=your-server-id --token=your-token

# å¸è½½
curl -sSL https://raw.githubusercontent.com/nspass/nspass-agent/main/scripts/uninstall.sh | sudo bash
```

### å¼€å‘ç¯å¢ƒæµ‹è¯•
```bash
# æµ‹è¯•å®‰è£…æœ¬åœ°æ„å»º
sudo ./scripts/test-install.sh --server-id=test-server --token=test-token

# æ„å»ºå‘å¸ƒç‰ˆæœ¬
./scripts/release.sh v1.0.0
```

### å‘å¸ƒæ–°ç‰ˆæœ¬
```bash
# ä½¿ç”¨ Makefile
make release VERSION=v1.0.0

# å‘å¸ƒåˆ° GitHub
make release-github VERSION=v1.0.0
```

## ğŸ”§ é…ç½®æ”¹è¿›

### é»˜è®¤é…ç½®æ–‡ä»¶å¢å¼º
- æ·»åŠ å®Œæ•´çš„é…ç½®é¡¹è¯´æ˜
- åŒ…å«å®‰å…¨çš„é»˜è®¤å€¼
- æ”¯æŒæµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒé…ç½®

### æƒé™å’Œå®‰å…¨
- æ­£ç¡®çš„æ–‡ä»¶æƒé™è®¾ç½®
- å®‰å…¨çš„ç›®å½•åˆ›å»º
- æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

## ğŸš¨ é”™è¯¯å¤„ç†å¢å¼º

### ç½‘ç»œé”™è¯¯å¤„ç†
- GitHub API è®¿é—®å¤±è´¥çš„å›é€€æœºåˆ¶
- ä¸‹è½½å¤±è´¥çš„é‡è¯•å’Œé”™è¯¯æç¤º
- ç½‘ç»œè¿æ¥æ£€æŸ¥

### ç³»ç»Ÿå…¼å®¹æ€§
- å¤šç§ Linux å‘è¡Œç‰ˆæ”¯æŒ
- ä¾èµ–åŒ…è‡ªåŠ¨å®‰è£…
- æ¶æ„æ£€æµ‹å’ŒéªŒè¯

## ğŸ“Š æµ‹è¯•å’ŒéªŒè¯

### åŠŸèƒ½æµ‹è¯•
- å®‰è£…è„šæœ¬åŠŸèƒ½æµ‹è¯•
- å¸è½½è„šæœ¬æ¸…ç†éªŒè¯
- æœåŠ¡å¯åŠ¨å’ŒçŠ¶æ€æ£€æŸ¥

### å…¼å®¹æ€§æµ‹è¯•
- å¤šæ¶æ„æ”¯æŒæµ‹è¯•
- ä¸åŒæ“ä½œç³»ç»Ÿæµ‹è¯•
- ç½‘ç»œç¯å¢ƒæµ‹è¯•

## ğŸ”„ æŒç»­æ”¹è¿›

### ç›‘æ§å’Œæ—¥å¿—
- è¯¦ç»†çš„å®‰è£…æ—¥å¿—
- é”™è¯¯ä¿¡æ¯æ”¶é›†
- æ€§èƒ½ç›‘æ§

### ç”¨æˆ·ä½“éªŒ
- æ¸…æ™°çš„æç¤ºä¿¡æ¯
- è¯¦ç»†çš„å¸®åŠ©æ–‡æ¡£
- æ•…éšœæ’é™¤æŒ‡å—

## ğŸ“ æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¼˜åŒ–ï¼ŒNSPass Agent çš„å®‰è£…å’Œéƒ¨ç½²ä½“éªŒå¾—åˆ°äº†æ˜¾è‘—æ”¹å–„ï¼š

1. **è‡ªåŠ¨åŒ–ç¨‹åº¦æé«˜**: ä»æ‰‹åŠ¨å®‰è£…åˆ°ä¸€é”®è‡ªåŠ¨å®‰è£…ï¼Œæ”¯æŒå‚æ•°ç›´æ¥é…ç½®
2. **é…ç½®ç®€åŒ–**: æ”¯æŒé€šè¿‡å‘½ä»¤è¡Œå‚æ•°ç›´æ¥è®¾ç½®æœåŠ¡å™¨IDå’ŒAPIä»¤ç‰Œï¼Œæ— éœ€æ‰‹åŠ¨ç¼–è¾‘é…ç½®æ–‡ä»¶
3. **é”™è¯¯å¤„ç†å®Œå–„**: æ›´å¥½çš„é”™è¯¯æç¤ºå’Œæ¢å¤æœºåˆ¶
4. **å¹³å°æ”¯æŒæ‰©å±•**: æ”¯æŒæ›´å¤šæ¶æ„å’Œæ“ä½œç³»ç»Ÿ
5. **å¼€å‘ä½“éªŒæ”¹å–„**: å®Œå–„çš„æµ‹è¯•å’Œå‘å¸ƒå·¥å…·ï¼Œæ”¯æŒå‚æ•°åŒ–æµ‹è¯•
6. **æ–‡æ¡£å®Œå–„**: è¯¦ç»†çš„å®‰è£…å’Œä½¿ç”¨æŒ‡å—

### ğŸ”‘ æ ¸å¿ƒæ”¹è¿›

- **ä¸€é”®é…ç½®**: `--server-id` å’Œ `--token` å‚æ•°è®©é…ç½®å˜å¾—æå…¶ç®€å•
- **è‡ªåŠ¨å†™å…¥**: å‚æ•°ç›´æ¥å†™å…¥é…ç½®æ–‡ä»¶ï¼Œå³è£…å³ç”¨
- **å‘åå…¼å®¹**: ä»ç„¶æ”¯æŒä¼ ç»Ÿçš„æ‰‹åŠ¨é…ç½®æ–¹å¼
- **æ™ºèƒ½å¤„ç†**: ç°æœ‰é…ç½®æ–‡ä»¶çš„æ™ºèƒ½æ›´æ–°å’Œå¤‡ä»½
- **å¼€å‘å‹å¥½**: æµ‹è¯•è„šæœ¬åŒæ ·æ”¯æŒå‚æ•°é…ç½®

è¿™äº›æ”¹è¿›ä½¿å¾— NSPass Agent æ›´å®¹æ˜“éƒ¨ç½²ã€ç»´æŠ¤å’Œä½¿ç”¨ï¼Œç‰¹åˆ«æ˜¯æ‰¹é‡éƒ¨ç½²åœºæ™¯ä¸‹çš„ä½“éªŒå¾—åˆ°äº†æå¤§æå‡ã€‚

## 7. GitHub Actions æƒé™é—®é¢˜æ’æŸ¥ä¸è§£å†³ (2024-01-XX)

### é—®é¢˜æè¿°
åœ¨è‡ªåŠ¨åŒ– release è¿‡ç¨‹ä¸­é‡åˆ° 403 Forbidden é”™è¯¯ï¼Œä¸»è¦è¡¨ç°ä¸ºï¼š
- `Resource not accessible by integration`
- `Request failed due to following response errors: * You must have push access to the repository to create releases`

### è§£å†³æ–¹æ¡ˆ

#### 7.1 æƒé™é…ç½®ä¼˜åŒ–
- **å¢å¼º workflow æƒé™**: åœ¨ `.github/workflows/release.yml` ä¸­æ·»åŠ æ›´å…¨é¢çš„æƒé™é…ç½®
- **å‡çº§ action ç‰ˆæœ¬**: ä½¿ç”¨æœ€æ–°çš„ `softprops/action-gh-release@v2`
- **æ·»åŠ è°ƒè¯•æ­¥éª¤**: åŒ…å« GitHub API è®¿é—®æµ‹è¯•å’Œæƒé™éªŒè¯

#### 7.2 æ•…éšœæ’é™¤å·¥å…·
- **è¯Šæ–­è„šæœ¬**: åˆ›å»º `diagnose-github-permissions-v2.sh` å¢å¼ºç‰ˆè¯Šæ–­å·¥å…·
- **è°ƒè¯• workflow**: æ–°å¢ `debug-permissions.yml` ä¸“é—¨ç”¨äºæƒé™è°ƒè¯•
- **åœºæ™¯æµ‹è¯•**: åˆ›å»º `test-release-scenarios.yml` æµ‹è¯•ä¸åŒå‘å¸ƒåœºæ™¯

#### 7.3 å¤‡ç”¨æ–¹æ¡ˆ
- **API ç›´æ¥è°ƒç”¨**: åœ¨ action å¤±è´¥æ—¶ä½¿ç”¨ GitHub API ç›´æ¥åˆ›å»º release
- **PAT æ”¯æŒ**: æ”¯æŒä½¿ç”¨ Personal Access Token æ›¿ä»£ GITHUB_TOKEN
- **æ‰‹åŠ¨å‘å¸ƒ**: æä¾›å®Œæ•´çš„æ‰‹åŠ¨å‘å¸ƒæµç¨‹æ–‡æ¡£

### æŠ€æœ¯ç»†èŠ‚

#### æƒé™é…ç½®
```yaml
permissions:
  contents: write       # åˆ›å»º releases å’Œ tags
  packages: write       # å‘å¸ƒåŒ…
  issues: write         # åˆ›å»º issues
  pull-requests: write  # åˆ›å»º PRs
  actions: write        # ç®¡ç† workflow runs
```

#### æ•…éšœæ’é™¤æµç¨‹
1. **è‡ªåŠ¨è¯Šæ–­**: è¿è¡Œè¯Šæ–­è„šæœ¬æ£€æŸ¥é…ç½®
2. **æƒé™æµ‹è¯•**: æµ‹è¯• GitHub API è®¿é—®æƒé™
3. **åœºæ™¯éªŒè¯**: ä½¿ç”¨ä¸åŒåœºæ™¯æµ‹è¯• release åˆ›å»º
4. **å¤‡ç”¨æ–¹æ¡ˆ**: å¦‚æœ action å¤±è´¥ï¼Œä½¿ç”¨ API ç›´æ¥åˆ›å»º

#### æ–°å¢æ–‡ä»¶
- `.github/workflows/debug-permissions.yml` - æƒé™è°ƒè¯• workflow
- `.github/workflows/test-release-scenarios.yml` - åœºæ™¯æµ‹è¯• workflow
- `scripts/diagnose-github-permissions-v2.sh` - å¢å¼ºç‰ˆè¯Šæ–­è„šæœ¬
- `docs/troubleshooting-release-403.md` - æ•…éšœæ’é™¤æŒ‡å—

### ä¼˜åŒ–æ•ˆæœ
- **æé«˜æˆåŠŸç‡**: å¤šå±‚æ¬¡çš„æƒé™éªŒè¯å’Œå¤‡ç”¨æ–¹æ¡ˆ
- **å¿«é€Ÿè¯Šæ–­**: è‡ªåŠ¨åŒ–è¯Šæ–­å·¥å…·å¿«é€Ÿå®šä½é—®é¢˜
- **è¯¦ç»†æ–‡æ¡£**: å®Œæ•´çš„æ•…éšœæ’é™¤æŒ‡å—å’Œè§£å†³æ–¹æ¡ˆ
- **çµæ´»é…ç½®**: æ”¯æŒ GITHUB_TOKEN å’Œ PAT ä¸¤ç§è®¤è¯æ–¹å¼

### ä½¿ç”¨æ–¹æ³•
```bash
# è¿è¡Œè¯Šæ–­
./scripts/diagnose-github-permissions-v2.sh

# æµ‹è¯•æƒé™
gh workflow run debug-permissions.yml

# æµ‹è¯•åœºæ™¯
gh workflow run test-release-scenarios.yml -f scenario=basic

# æ‰‹åŠ¨å‘å¸ƒ
gh release create v1.0.0 --title "Release v1.0.0" --notes-file release/RELEASE_NOTES.md
```
