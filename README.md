# NSPass Agent

NSPass Agent æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„Linuxç³»ç»Ÿä»£ç†æœåŠ¡ç®¡ç†ç¨‹åºï¼Œæ”¯æŒå¤šç§ä»£ç†åè®®ã€æ™ºèƒ½é˜²ç«å¢™ç®¡ç†å’Œä¼ä¸šçº§ç›‘æ§åŠŸèƒ½ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸŒ **å¤šåè®®ä»£ç†æ”¯æŒ**
- **Shadowsocks**: åŸºäºshadowsocks-libevçš„é«˜æ€§èƒ½å®ç°
- **Trojan**: æ”¯æŒæœ€æ–°ç‰ˆæœ¬çš„Trojanä»£ç†åè®®
- **Snell**: é«˜é€Ÿçš„Snellä»£ç†æœåŠ¡å™¨æ”¯æŒ
- **æ’ä»¶åŒ–æ¶æ„**: æ˜“äºæ‰©å±•æ”¯æŒæ›´å¤šä»£ç†åè®®

### ğŸ”„ **æ™ºèƒ½è¿›ç¨‹ç›‘æ§** â­ï¸ **NEW**
- **å®æ—¶å¥åº·æ£€æŸ¥**: å®šæ—¶æ£€æµ‹ä»£ç†è¿›ç¨‹è¿è¡ŒçŠ¶æ€
- **è‡ªåŠ¨æ•…éšœæ¢å¤**: æ£€æµ‹åˆ°è¿›ç¨‹å´©æºƒæ—¶è‡ªåŠ¨é‡å¯
- **æ™ºèƒ½é‡å¯ç­–ç•¥**: å†·å´æœŸä¿æŠ¤å’Œé‡å¯æ¬¡æ•°é™åˆ¶
- **å¹¶å‘ç›‘æ§**: æ”¯æŒåŒæ—¶ç›‘æ§å¤šä¸ªä»£ç†è¿›ç¨‹
- **è¯¦ç»†ç»Ÿè®¡**: é‡å¯å†å²ã€æ€§èƒ½æŒ‡æ ‡ã€çŠ¶æ€åˆ†å¸ƒ
- **çµæ´»é…ç½®**: æ”¯æŒä¸åŒç¯å¢ƒçš„å·®å¼‚åŒ–ç›‘æ§ç­–ç•¥

### ğŸ”§ **APIé©±åŠ¨é…ç½®**
- **åŠ¨æ€é…ç½®**: ä»REST APIè‡ªåŠ¨è·å–å’ŒåŒæ­¥é…ç½®
- **æ™ºèƒ½é‡è¯•**: å†…ç½®é‡è¯•æœºåˆ¶ç¡®ä¿é…ç½®åŒæ­¥å¯é æ€§
- **ç‰ˆæœ¬ç®¡ç†**: æ”¯æŒé…ç½®ç‰ˆæœ¬æ§åˆ¶å’Œå›æ»š
- **å®æ—¶æ›´æ–°**: æ”¯æŒé…ç½®çƒ­æ›´æ–°æ— éœ€é‡å¯æœåŠ¡

### ğŸ›¡ï¸ **IPTablesé˜²ç«å¢™ç®¡ç†**
- **æ™ºèƒ½è§„åˆ™ç®¡ç†**: åŸºäºiptables-save/restoreçš„é«˜æ•ˆæ“ä½œ
- **åŸå­æ€§æ›´æ–°**: ç¡®ä¿è§„åˆ™æ›´æ–°çš„åŸå­æ€§å’Œä¸€è‡´æ€§
- **è‡ªåŠ¨å¤‡ä»½**: è‡ªåŠ¨å¤‡ä»½å’Œæ¢å¤é˜²ç«å¢™è§„åˆ™
- **å¢é‡åŒæ­¥**: æ™ºèƒ½å¯¹æ¯”å’Œå¢é‡æ›´æ–°è§„åˆ™

### ğŸ“Š **ä¼ä¸šçº§æ—¥å¿—ç³»ç»Ÿ**
- **ç»“æ„åŒ–æ—¥å¿—**: åŸºäºJSONæ ¼å¼çš„ç»“æ„åŒ–æ—¥å¿—è¾“å‡º
- **è‡ªåŠ¨è½®è½¬**: åŸºäºæ—¶é—´ã€å¤§å°çš„æ™ºèƒ½æ—¥å¿—è½®è½¬
- **ç»„ä»¶éš”ç¦»**: æ¯ä¸ªç»„ä»¶ç‹¬ç«‹çš„æ—¥å¿—å‘½åç©ºé—´
- **æ€§èƒ½ç›‘æ§**: å†…ç½®æ€§èƒ½æŒ‡æ ‡å’Œå®¡è®¡æ—¥å¿—
- **å¤šè¾“å‡ºæ”¯æŒ**: åŒæ—¶è¾“å‡ºåˆ°æ–‡ä»¶å’Œæ§åˆ¶å°

### ğŸ—ï¸ **ç”Ÿäº§å°±ç»ªæ¶æ„**
- **Systemdé›†æˆ**: å®Œæ•´çš„systemdæœåŠ¡æ–‡ä»¶å’Œç®¡ç†è„šæœ¬
- **ä¼˜é›…å…³é—­**: æ”¯æŒä¿¡å·å¤„ç†å’Œä¼˜é›…å…³é—­æµç¨‹
- **å¥åº·æ£€æŸ¥**: å†…ç½®å¥åº·æ£€æŸ¥å’ŒçŠ¶æ€ç›‘æ§æ¥å£
- **é…ç½®éªŒè¯**: å¯åŠ¨æ—¶è‡ªåŠ¨éªŒè¯é…ç½®æ–‡ä»¶åˆæ³•æ€§
- **é”™è¯¯æ¢å¤**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œè‡ªåŠ¨æ¢å¤æœºåˆ¶

## ğŸ¯ ç›‘æ§æ¡†æ¶äº®ç‚¹

### å®æ—¶ç›‘æ§èƒ½åŠ›
```yaml
proxy:
  monitor:
    enable: true          # å¯ç”¨ç›‘æ§
    check_interval: 30    # 30ç§’æ£€æŸ¥é—´éš”
    restart_cooldown: 60  # 60ç§’é‡å¯å†·å´
    max_restarts: 10      # æ¯å°æ—¶æœ€å¤š10æ¬¡é‡å¯
    health_timeout: 5     # 5ç§’å¥åº·æ£€æŸ¥è¶…æ—¶
```

### æ™ºèƒ½æ•…éšœæ¢å¤
- ğŸ” **è¿›ç¨‹çŠ¶æ€æ£€æµ‹**: å®šæ—¶æ£€æŸ¥æ‰€æœ‰ä»£ç†è¿›ç¨‹å¥åº·çŠ¶æ€
- âš¡ **å¿«é€Ÿæ•…éšœæ¢å¤**: æ£€æµ‹åˆ°å´©æºƒåç«‹å³è‡ªåŠ¨é‡å¯
- ğŸ›¡ï¸ **é˜²æŠ¤æœºåˆ¶**: å†·å´æœŸå’Œé¢‘ç‡é™åˆ¶é˜²æ­¢é¢‘ç¹é‡å¯
- ğŸ“ˆ **ç»Ÿè®¡åˆ†æ**: è¯¦ç»†çš„é‡å¯å†å²å’Œæ€§èƒ½ç»Ÿè®¡

### ç¯å¢ƒè‡ªé€‚åº”é…ç½®
- **å¼€å‘ç¯å¢ƒ**: å¿«é€Ÿæ£€æµ‹(10s)ï¼Œå®½æ¾é‡å¯ç­–ç•¥(20æ¬¡/å°æ—¶)
- **ç”Ÿäº§ç¯å¢ƒ**: ç¨³å®šä¼˜å…ˆ(60s)ï¼Œä¿å®ˆé‡å¯ç­–ç•¥(5æ¬¡/å°æ—¶)  
- **é«˜å¯ç”¨ç¯å¢ƒ**: å¹³è¡¡ç­–ç•¥(15s)ï¼Œé€‚ä¸­é‡å¯é™åˆ¶(15æ¬¡/å°æ—¶)

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux (Ubuntu 18.04+, CentOS 7+, Debian 9+)
- **Goç‰ˆæœ¬**: Go 1.24+ (æ„å»ºæ—¶)
- **ç³»ç»Ÿæƒé™**: rootæƒé™ (ç”¨äºiptableså’Œsystemdæ“ä½œ)
- **ä¾èµ–åŒ…**: iptables, systemctl
- **ç½‘ç»œ**: èƒ½å¤Ÿè®¿é—®é…ç½®APIæœåŠ¡å™¨

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ä¸‹è½½å’Œå®‰è£…
```bash
# ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
wget https://github.com/nspass/nspass-agent/releases/latest/download/nspass-agent-linux-amd64.tar.gz

# è§£å‹å®‰è£…
tar -xzf nspass-agent-linux-amd64.tar.gz
sudo ./install.sh
```

### 2. é…ç½®æ–‡ä»¶
åˆ›å»ºé…ç½®æ–‡ä»¶ `/etc/nspass/config.yaml`:
```yaml
# APIé…ç½®
api:
  base_url: "https://your-api-server.com"
  token: "your-api-token"

# ä»£ç†é…ç½®
proxy:
  enabled_types: ["shadowsocks", "trojan", "snell"]
  auto_start: true
  
  # ç›‘æ§é…ç½®
  monitor:
    enable: true
    check_interval: 30
    max_restarts: 10

# æ—¥å¿—é…ç½®  
logger:
  level: "info"
  format: "json"
  output: "both"
  file: "/var/log/nspass/agent.log"
```

### 3. å¯åŠ¨æœåŠ¡
```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start nspass-agent
sudo systemctl enable nspass-agent

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status nspass-agent

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u nspass-agent -f
```

## ğŸ“– è¯¦ç»†æ–‡æ¡£

- [æ—¥å¿—ç³»ç»Ÿä½¿ç”¨æŒ‡å—](docs/logger-usage.md)
- [ä»£ç†ç›‘æ§æ¡†æ¶](docs/proxy-monitor.md)
- [IPTablesç®¡ç†è¯´æ˜](docs/iptables-persistent.md)
- [é…ç½®æ–‡ä»¶å‚è€ƒ](configs/config-with-monitor.yaml)

## âš™ï¸ é…ç½®ç¤ºä¾‹

### å®Œæ•´é…ç½®ç¤ºä¾‹
å‚è§: [configs/config-with-monitor.yaml](configs/config-with-monitor.yaml)

### ç›‘æ§é…ç½®ç¤ºä¾‹
```yaml
# å¼€å‘ç¯å¢ƒ
proxy:
  monitor:
    enable: true
    check_interval: 10      # å¿«é€Ÿæ£€æµ‹
    restart_cooldown: 30    # çŸ­å†·å´æœŸ
    max_restarts: 20        # å®½æ¾ç­–ç•¥

# ç”Ÿäº§ç¯å¢ƒ
proxy:
  monitor:
    enable: true
    check_interval: 60      # ç¨³å®šä¼˜å…ˆ
    restart_cooldown: 120   # ä¿å®ˆç­–ç•¥
    max_restarts: 5         # ä¸¥æ ¼é™åˆ¶
```

## ğŸ”§ æ„å»ºå’Œå¼€å‘

### æœ¬åœ°æ„å»º
```bash
# å…‹éš†ä»“åº“
git clone https://github.com/nspass/nspass-agent.git
cd nspass-agent

# å®‰è£…ä¾èµ–
go mod tidy

# æ„å»º
make build

# è¿è¡Œæµ‹è¯•
make test
```

### å¼€å‘ç¯å¢ƒè¿è¡Œ
```bash
# ä½¿ç”¨æµ‹è¯•é…ç½®è¿è¡Œ
go run cmd/nspass-agent/main.go -c test/test-monitor-config.yaml --log-level=debug
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### ç›‘æ§æŒ‡æ ‡
- ä»£ç†è¿›ç¨‹çŠ¶æ€å’Œè¿è¡Œæ—¶é—´
- é‡å¯æ¬¡æ•°å’ŒæˆåŠŸç‡ç»Ÿè®¡
- å¥åº·æ£€æŸ¥è€—æ—¶å’Œè¶…æ—¶æ¬¡æ•°
- é…ç½®åŒæ­¥é¢‘ç‡å’Œé”™è¯¯ç‡

### æ•…éšœæ’æŸ¥
```bash
# æŸ¥çœ‹ç›‘æ§çŠ¶æ€
curl localhost:8080/api/monitor/status

# æ£€æŸ¥ä»£ç†çŠ¶æ€
sudo systemctl status nspass-agent

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
sudo journalctl -u nspass-agent --no-pager -l
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

æˆ‘ä»¬æ¬¢è¿ç¤¾åŒºè´¡çŒ®ï¼è¯·æŸ¥çœ‹ [CONTRIBUTING.md](CONTRIBUTING.md) äº†è§£è´¡çŒ®æµç¨‹ã€‚

### å¼€å‘è§„èŒƒ
- éµå¾ªGoä»£ç è§„èŒƒ
- æ·»åŠ å……åˆ†çš„å•å…ƒæµ‹è¯•
- æ›´æ–°ç›¸å…³æ–‡æ¡£
- æäº¤å‰è¿è¡Œå®Œæ•´æµ‹è¯•

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## ğŸ†˜ æ”¯æŒ

- **æ–‡æ¡£**: [åœ¨çº¿æ–‡æ¡£](https://nspass.github.io/nspass-agent/)
- **Issues**: [GitHub Issues](https://github.com/nspass/nspass-agent/issues)
- **è®¨è®º**: [GitHub Discussions](https://github.com/nspass/nspass-agent/discussions)

---

â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™æˆ‘ä»¬ä¸€ä¸ªæ˜Ÿæ ‡ï¼